<?xml version="1.0" encoding="UTF-8"?>
<!--
  ~ Copyright 2017 Branislav Cavlin
  ~
  ~ Licensed under the Apache License, Version 2.0 (the "License");
  ~ you may not use this file except in compliance with the License.
  ~ You may obtain a copy of the License at
  ~
  ~     http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License.
  -->

<!DOCTYPE html
        PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://java.sun.com/jsf/html"
      xmlns:ui="http://java.sun.com/jsf/facelets"
      xmlns:p="http://primefaces.org/ui"
      xmlns:pe="http://primefaces.org/ui/extensions"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:fn="http://java.sun.com/jsp/jstl/functions"
      xmlns:fmt="http://omnifaces.org/functions">
<ui:composition template="templates/ApplicationTemplate.xhtml">
    <ui:define name="center">
        <h:panelGroup id="main-layout" styleClass="main-layout" layout="block" style="margin: 15px 0 15px 0">
            <h:form id="main-form" onkeypress="return event.keyCode !== 13">
                <h:panelGrid columns="2" columnClasses="invoice-column-1 invoice-column-2" style="width: 100%;">
                    <h:panelGroup id="invoice-panel" style="text-align: left;">

                        <h:panelGroup id="buttons-1-group" layout="block" style="margin-bottom: 15px;">
                            <p:commandButton value="New Invoice" icon="ui-icon-extlink" style="margin-right: 15px;"
                                             oncomplete="PF('invoice-form-dialog').show();"
                                             actionListener="#{invoiceBean.newEntryListener}"
                                             update="main-form,invoice-form"/>
                            <p:commandButton value="Edit Invoice (#{invoiceBean.selectedInvoiceEntity.invoiceId})"
                                             icon="ui-icon-pencil"
                                             rendered="#{!empty invoiceBean.selectedInvoiceEntity and invoiceBean.selectedInvoiceEntity.invoiceId gt 0}"
                                             style="margin-right: 15px;" oncomplete="PF('invoice-form-dialog').show();"
                                             update="main-form,invoice-form"/>
                            <p:commandButton
                                    value="Delete Invoice (#{invoiceBean.selectedInvoiceEntity.invoiceId})"
                                    icon="ui-icon-trash"
                                    rendered="#{!empty invoiceBean.selectedInvoiceEntity and invoiceBean.selectedInvoiceEntity.invoiceId gt 0}"
                                    style="margin-right: 15px; color: brown;" oncomplete="PF('confirmation1').show();"/>

                            <p:confirmDialog message="Do you want to remove this Invoice?"
                                             showEffect="bounce"
                                             header="Delete Invoice"
                                             severity="alert"
                                             widgetVar="confirmation1">
                                <p:commandButton value="Remove ID (#{invoiceBean.selectedInvoiceEntity.invoiceId})"
                                                 oncomplete="PF('confirmation1').hide()"
                                                 actionListener="#{invoiceBean.deleteEntryListener}"
                                                 update="main-form,invoice-form"
                                                 style="color: brown;"/>
                                <p:commandButton value="No" oncomplete="PF('confirmation1').hide()" type="button"/>
                            </p:confirmDialog>
                        </h:panelGroup>

                        <!--@elvariable id="invoice" type="com.bgh.myopeninvoice.db.model.InvoiceEntity"-->
                        <p:dataTable id="invoice-table"
                                     var="invoice"
                                     widgetVar="invoice-table"
                                     value="#{invoiceBean.invoiceEntityLazyDataModel}"
                                     rows="#{invoiceBean.pageSize}"
                                     rowKey="#{invoice.invoiceId}"
                                     selection="#{invoiceBean.selectedInvoiceEntity}"
                                     selectionMode="single"
                                     emptyMessage="No items found with given criteria"
                                     scrollable="true"
                                     scrollWidth="638"
                                     lazy="true"
                                     paginatorPosition="bottom"
                                     paginator="true"
                                     paginatorTemplate="{CurrentPageReport} {FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink}">

                            <p:ajax event="rowSelect" update="main-form"
                                    listener="#{invoiceBean.ajaxChangeRowListener}"/>

                            <p:column headerText="Id" sortBy="#{invoice.invoiceId}" style="text-align:right;"
                                      width="50">
                                <h:outputText value="#{invoice.invoiceId}"/>
                            </p:column>
                            <p:column headerText="From"
                                      sortBy="#{invoice.companyContactByCompanyContactFrom.companiesByCompanyId.companyName}"
                                      style="text-align:start;" width="150">
                                <h:outputText
                                        value="#{invoice.companyContactByCompanyContactFrom.companiesByCompanyId.companyName}"/>
                            </p:column>
                            <p:column headerText="To" sortBy="#{invoice.companiesByCompanyTo.companyName}"
                                      style="text-align:start;" width="150">
                                <h:outputText value="#{invoice.companiesByCompanyTo.companyName}"/>
                            </p:column>
                            <p:column headerText="Title" sortBy="#{invoice.title}" style="text-align:start;"
                                      width="100">
                                <h:outputText value="#{invoice.title}"/>
                            </p:column>
                            <p:column headerText="Created" sortBy="#{invoice.createdDate}" style="text-align:center;"
                                      width="120">
                                <h:outputText value="#{invoice.createdDate}"/>
                            </p:column>
                            <p:column headerText="Due" sortBy="#{invoice.dueDate}" style="text-align:center;"
                                      width="120">
                                <h:outputText value="#{invoice.dueDate}"/>
                            </p:column>
                            <p:column headerText="Rate" sortBy="#{invoice.rate}" style="text-align:right;" width="70">
                                <h:outputText value="#{invoice.rate}"/>
                            </p:column>
                            <p:column headerText="Unit" sortBy="#{invoice.rateUnit}" style="text-align:center;"
                                      width="70">
                                <h:outputText value="#{invoice.rateUnit}"/>
                            </p:column>
                            <p:column headerText="CCY" sortBy="#{invoice.currencyByCcy.name}" style="text-align:center;"
                                      width="70">
                                <h:outputText value="#{invoice.currencyByCcy.name}"/>
                            </p:column>
                            <p:column headerText="Paid" sortBy="#{invoice.paidDate}" style="text-align:center;"
                                      width="120">
                                <h:outputText value="#{invoice.paidDate}"/>
                            </p:column>
                            <p:column headerText="Tax" sortBy="#{invoice.taxPercent}" style="text-align:right;"
                                      width="70">
                                <h:outputText value="#{invoice.taxPercent}"/>
                            </p:column>
                            <p:column headerText="Note" sortBy="#{invoice.note}" style="text-align:start;" width="500">
                                <h:outputText value="#{invoice.note}"/>
                            </p:column>
                        </p:dataTable>
                    </h:panelGroup>

                    <h:panelGroup id="invoice-items-panel">
                        Items
                    </h:panelGroup>

                    <h:panelGroup id="attachments-panel">
                        Attachments
                    </h:panelGroup>

                    <h:panelGroup id="timesheet-panel">
                        Timesheet
                    </h:panelGroup>
                </h:panelGrid>
            </h:form>
        </h:panelGroup>
    </ui:define>

    <ui:define name="dialog">
        <p:dialog id="invoice-form-dialog" closable="true" closeOnEscape="true" dynamic="true" appendTo="@(body)"
                  widgetVar="invoice-form-dialog" width="500" modal="true" resizable="false">
            <f:facet name="header">
                <h:outputText value="Add/Edit Invoice"/>
            </f:facet>
            <h:form id="invoice-form">
                <p:focus for="from"/>
                <p:messages autoUpdate="true"/>

                <h:panelGrid id="invoice-form-grid1" columns="2" columnClasses="two-column-1 two-column-2"
                             style="padding-top: 3px;">

                    <p:outputLabel value="ID:"/>
                    <h:outputText value="#{invoiceBean.selectedInvoiceEntity.invoiceId}" style="margin-left: 5px;"/>

                    <p:outputLabel value="From:"/>
                    <p:selectOneMenu id="from" value="#{invoiceBean.selectedInvoiceEntity.companyContactFrom}"
                                     required="true" style="margin-left: 5px;">
                        <f:selectItem itemLabel="---Select Company Owned By You---" itemValue=""/>
                        <f:selectItems var="selection1"
                                       value="#{invoiceBean.companyContactEntityCollectionForSelection}"
                                       itemLabel="#{selection1.companiesByCompanyId.companyName}"
                                       itemValue="#{selection1.companyContactId}"/>
                        <p:ajax event="change" update="@form" listener="#{invoiceBean.updateSelectionFromTo}"/>
                    </p:selectOneMenu>

                    <p:outputLabel value="To:"/>
                    <p:selectOneMenu id="to" value="#{invoiceBean.selectedInvoiceEntity.companyTo}"
                                     required="true" style="margin-left: 5px;"
                                     valueChangeListener="#{invoiceBean.updateSelectionFromTo}">
                        <f:selectItem itemLabel="---Select Company NOT Owned By You---" itemValue=""/>
                        <f:selectItems var="selection2"
                                       value="#{invoiceBean.companiesEntityCollectionForSelection}"
                                       itemLabel="#{selection2.companyName}, contracts (#{fn:length(selection2.contractsByCompanyId)})"
                                       itemValue="#{selection2.companyId}"/>
                        <p:ajax event="change" update="@form" listener="#{invoiceBean.updateSelectionFromTo}"/>
                    </p:selectOneMenu>

                    <p:outputLabel value="Tax %:"/>
                    <p:selectOneMenu id="tax" value="#{invoiceBean.selectedInvoiceEntity.taxPercent}"
                                     required="true" style="margin-left: 5px;">
                        <f:selectItems var="selection3"
                                       value="#{invoiceBean.taxEntityCollectionForSelection}"
                                       itemLabel="#{fmt:formatNumber(selection3.percent * 100.00, '0.00')} - #{selection3.identifier}"
                                       itemValue="#{selection3.percent}"/>
                    </p:selectOneMenu>

                    <p:outputLabel value="Created:"/>
                    <p:calendar value="#{invoiceBean.selectedInvoiceEntity.createdDate}" style="margin-left: 5px;"
                                pattern="yyyy-MM-dd" maxlength="10" id="created-date" required="true"/>

                    <p:outputLabel value="Due:"/>
                    <p:calendar value="#{invoiceBean.selectedInvoiceEntity.dueDate}" style="margin-left: 5px;"
                                pattern="yyyy-MM-dd" maxlength="10" id="due-date" required="true"/>

                    <p:outputLabel value="Rate:" rendered="#{not empty invoiceBean.selectedInvoiceEntity.rateUnit}"/>
                    <h:panelGroup id="rate-grp" style="font-weight: bold;" rendered="#{not empty invoiceBean.selectedInvoiceEntity.rateUnit}">
                        <h:outputText value="${invoiceBean.selectedInvoiceEntity.rate}" style="margin-left: 5px;">
                            <f:convertNumber pattern="0.00"/>
                        </h:outputText>
                        <h:outputText value="${invoiceBean.selectedInvoiceEntity.currencyByCcy.name}"
                                      style="margin-left: 5px;"/>
                        <h:outputText value="per ${invoiceBean.selectedInvoiceEntity.rateUnit}" style="margin-left: 5px;"/>
                    </h:panelGroup>

                </h:panelGrid>

                <h:panelGroup layout="block">
                    <p:separator style="margin: 10px 0 10px 0"/>
                    <p:commandButton value="Submit" type="submit"
                                     actionListener="#{invoiceBean.addOrEditEntryListener}"
                                     update="invoice-form,main-form"/>
                </h:panelGroup>
            </h:form>
        </p:dialog>
    </ui:define>
</ui:composition>
</html>